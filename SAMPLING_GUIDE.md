# æ•°æ®é›†é‡‡æ ·å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«æ•°æ®é›†é‡‡æ ·å·¥å…·ï¼Œç”¨äºä»åŸå§‹è®­ç»ƒæ•°æ®ä¸­ä¸ºæ¯ä¸ªç”¨æˆ·éšæœºé€‰æ‹©æœ€å¤š N ä¸ªæ ·æœ¬ã€‚è¿™å¯¹äºä»¥ä¸‹åœºæ™¯å¾ˆæœ‰ç”¨ï¼š

1. **å‡å°‘è®­ç»ƒæ—¶é—´**ï¼šä½¿ç”¨è¾ƒå°çš„æ•°æ®é›†è¿›è¡Œå¿«é€Ÿå®éªŒ
2. **é¿å…ç”¨æˆ·è¿‡æ‹Ÿåˆ**ï¼šé™åˆ¶æ¯ä¸ªç”¨æˆ·çš„æ ·æœ¬æ•°é‡ï¼Œæé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›
3. **å›ºå®šæ•°æ®é›†**ï¼šé¢„å…ˆé‡‡æ ·ç¡®ä¿æ¯æ¬¡è®­ç»ƒä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ•°æ®å­é›†

## ğŸ› ï¸ å·¥å…·æ–‡ä»¶

- `sample_dataset.py`: å•ä¸ªæ•°æ®é›†é‡‡æ ·è„šæœ¬
- `sample_all_datasets.sh`: æ‰¹é‡é‡‡æ ·æ‰€æœ‰æ•°æ®é›†çš„ shell è„šæœ¬
- `sampled_data/`: é‡‡æ ·åçš„æ•°æ®é›†å­˜å‚¨ç›®å½•

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: é‡‡æ ·å•ä¸ªæ•°æ®é›†

```bash
python sample_dataset.py \
    /path/to/input/train.json \
    /path/to/output/train_3.json \
    --max_samples 3 \
    --seed 42

python sample_dataset.py \
    /mnt/parallel/GIDigitalTwinBench/RealSelf/Chameleons/train.json \
    /mnt/parallel/GIDigitalTwinBench/RealSelf/Chameleons/train_3.json \
    --max_samples 3 \
    --seed 42
```

**å‚æ•°è¯´æ˜**:
- `input`: è¾“å…¥ JSON æ–‡ä»¶è·¯å¾„
- `output`: è¾“å‡º JSON æ–‡ä»¶è·¯å¾„
- `--max_samples N`: æ¯ä¸ªç”¨æˆ·æœ€å¤šä¿ç•™çš„æ ·æœ¬æ•°ï¼ˆé»˜è®¤: 3ï¼‰
- `--seed N`: éšæœºç§å­ï¼Œç¡®ä¿å¯é‡å¤æ€§ï¼ˆé»˜è®¤: 42ï¼‰
- `--user_id_field`: ç”¨æˆ· ID å­—æ®µåï¼ˆé»˜è®¤: user_hashï¼Œä¼šè‡ªåŠ¨æ£€æµ‹ï¼‰

### æ–¹æ³• 2: æ‰¹é‡é‡‡æ ·æ‰€æœ‰æ•°æ®é›†

```bash
bash sample_all_datasets.sh --max_samples 3 --seed 42 --force
```

**å‚æ•°è¯´æ˜**:
- `--max_samples N`: æ¯ç”¨æˆ·æœ€å¤šæ ·æœ¬æ•°ï¼ˆé»˜è®¤: 3ï¼‰
- `--seed N`: éšæœºç§å­ï¼ˆé»˜è®¤: 42ï¼‰
- `--force, -f`: å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ï¼ˆä¸æç¤ºï¼‰

## ğŸ“‚ é‡‡æ ·ç»“æœ

å½“å‰å·²é‡‡æ ·çš„æ•°æ®é›†ï¼ˆæ¯ç”¨æˆ·æœ€å¤š 3 ä¸ªæ ·æœ¬ï¼Œseed=42ï¼‰ï¼š

```
sampled_data/
â”œâ”€â”€ Chameleons/train_3.json           108M  (7,797 â†’ 7,207 æ ·æœ¬, -7.57%)
â”œâ”€â”€ DMSC/train_3.json                  36M  (7,220 â†’ 7,220 æ ·æœ¬, æ— å˜åŒ–)
â”œâ”€â”€ MovieLens/train_3.json             41M  (10,000 â†’ 10,000 æ ·æœ¬, æ— å˜åŒ–)
â”œâ”€â”€ PERSONA-Bench/train_3.json        366M  (100,273 â†’ 100,273 æ ·æœ¬, æ— å˜åŒ–)
â”œâ”€â”€ REALTALK/train_3.json              69M  (10 â†’ 10 æ ·æœ¬, æ— å˜åŒ–)
â”œâ”€â”€ TwinVoiceInterpersonalPersona/     18M  (5 â†’ 5 æ ·æœ¬, æ— å˜åŒ–)
â”‚   train_3.json
â””â”€â”€ TwinVoiceSocialPersona/            11M  (686 â†’ 686 æ ·æœ¬, æ— å˜åŒ–)
    train_3.json
```

### ç»Ÿè®¡ä¿¡æ¯

- **Chameleons**: å”¯ä¸€ç”¨æˆ· 6,117ï¼Œå¹³å‡æ¯ç”¨æˆ· 1.27 ä¸ªæ ·æœ¬
  - æœ‰ 164 ä¸ªç”¨æˆ·ï¼ˆ2.68%ï¼‰å—å½±å“ï¼Œç§»é™¤äº† 590 ä¸ªæ ·æœ¬ï¼ˆ7.57%ï¼‰
  - ä¿ç•™æ¯”ä¾‹: 92.43%

- **å…¶ä»–æ•°æ®é›†**: å¤§å¤šæ•°æ•°æ®é›†æ¯ä¸ªç”¨æˆ·åªæœ‰ 1 ä¸ªæ ·æœ¬ï¼Œå› æ­¤é‡‡æ ·åæ•°é‡ä¸å˜

## ğŸš€ ä½¿ç”¨é‡‡æ ·æ•°æ®é›†è¿›è¡Œè®­ç»ƒ

### æ–¹æ³• 1: ä¿®æ”¹é…ç½®æ–‡ä»¶

åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å‘é‡‡æ ·åçš„æ•°æ®é›†ï¼š

```json
{
  "model": {
    "name": "Qwen3-30B-A3B-Instruct-2507",
    "path": "/mnt/parallel/models/Qwen3-30B-A3B-Instruct-2507"
  },
  "data": {
    "train_path": "sampled_data/Chameleons/train_3.json"
  },
  ...
}
```

ç¤ºä¾‹é…ç½®æ–‡ä»¶: `config_Chameleons_30B_sampled3.json`

### æ–¹æ³• 2: è®­ç»ƒå‘½ä»¤ç¤ºä¾‹

```bash
torchrun \
    --nproc_per_node=8 \
    --master_port=29502 \
    train_distributed_Chameleons.py \
    --config config_Chameleons_30B_sampled3.json \
    --deepspeed ds_config_zero3_optimized.json \
    --ablation_config context_only \
    --output_dir outputs/Chameleons_context_30B_sampled3 \
    --max_epochs 50 \
    --val_ratio 0.1 \
    --wandb_project Qwen3_30B-Chameleons \
    --wandb_run_name context_sampled3_seed42 \
    --prompt_style simple
```

**æ³¨æ„**: ä½¿ç”¨é‡‡æ ·æ•°æ®é›†åï¼Œä¸éœ€è¦å†ä½¿ç”¨ `--max_samples_per_user` å’Œ `--sample_seed` å‚æ•°ï¼Œå› ä¸ºæ•°æ®å·²ç»é¢„å…ˆé‡‡æ ·å¥½äº†ã€‚

## ğŸ” é‡‡æ ·é€»è¾‘è¯´æ˜

1. **æŒ‰ç”¨æˆ·åˆ†ç»„**: æ ¹æ® `user_hash` æˆ– `user_id` å­—æ®µå°†æ ·æœ¬åˆ†ç»„
2. **éšæœºé‡‡æ ·**: å¯¹äºæ ·æœ¬æ•°è¶…è¿‡ `max_samples` çš„ç”¨æˆ·ï¼Œä½¿ç”¨ `random.sample()` éšæœºé€‰æ‹©
3. **ä¿ç•™å°‘æ ·æœ¬ç”¨æˆ·**: æ ·æœ¬æ•°ä¸è¶³ `max_samples` çš„ç”¨æˆ·ä¿ç•™å…¨éƒ¨æ ·æœ¬
4. **æ‰“ä¹±é¡ºåº**: æœ€ç»ˆç»“æœä¼šè¢«éšæœºæ‰“ä¹±ï¼Œé¿å…ç”¨æˆ·èšé›†
5. **å›ºå®šéšæœºç§å­**: ä½¿ç”¨å›ºå®šçš„ seed ç¡®ä¿æ¯æ¬¡é‡‡æ ·ç»“æœç›¸åŒ

## ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿

ä½¿ç”¨é‡‡æ ·æ•°æ®é›†çš„ä¼˜åŠ¿ï¼š

1. **è®­ç»ƒé€Ÿåº¦**: Chameleons å‡å°‘ 7.57% æ ·æœ¬ï¼Œå¯èŠ‚çœçº¦ 8% çš„è®­ç»ƒæ—¶é—´
2. **å†…å­˜å ç”¨**: æ›´å°çš„æ•°æ®é›†å‡å°‘å†…å­˜å³°å€¼
3. **æ•°æ®ä¸€è‡´æ€§**: æ¯æ¬¡è®­ç»ƒä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ•°æ®å­é›†ï¼Œç»“æœæ›´å…·å¯é‡å¤æ€§
4. **æ³›åŒ–èƒ½åŠ›**: é™åˆ¶æ¯ç”¨æˆ·æ ·æœ¬æ•°ï¼Œå‡å°‘è¿‡æ‹Ÿåˆé£é™©

## ğŸ”§ é«˜çº§ç”¨æ³•

### åˆ›å»ºä¸åŒé‡‡æ ·ç‡çš„æ•°æ®é›†

```bash
# æ¯ç”¨æˆ·æœ€å¤š 5 ä¸ªæ ·æœ¬
python sample_dataset.py input.json output/train_5.json --max_samples 5 --seed 42

# æ¯ç”¨æˆ·æœ€å¤š 10 ä¸ªæ ·æœ¬
python sample_dataset.py input.json output/train_10.json --max_samples 10 --seed 42
```

### ä½¿ç”¨ä¸åŒçš„éšæœºç§å­

```bash
# åˆ›å»ºä¸åŒçš„æ•°æ®å­é›†ç”¨äºäº¤å‰éªŒè¯
python sample_dataset.py input.json output/train_3_fold1.json --max_samples 3 --seed 42
python sample_dataset.py input.json output/train_3_fold2.json --max_samples 3 --seed 43
python sample_dataset.py input.json output/train_3_fold3.json --max_samples 3 --seed 44
```

## â“ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæœ‰äº›æ•°æ®é›†é‡‡æ ·åæ•°é‡æ²¡å˜åŒ–ï¼Ÿ**  
A: è¿™äº›æ•°æ®é›†ä¸­æ¯ä¸ªç”¨æˆ·åªæœ‰ 1 ä¸ªæ ·æœ¬ï¼Œå› æ­¤ `max_samples=3` æ—¶ä¸ä¼šç§»é™¤ä»»ä½•æ ·æœ¬ã€‚

**Q: å¯ä»¥åœ¨è®­ç»ƒæ—¶åŠ¨æ€é‡‡æ ·å—ï¼Ÿ**  
A: å¯ä»¥ä½¿ç”¨ `--max_samples_per_user` å‚æ•°è¿›è¡ŒåŠ¨æ€é‡‡æ ·ï¼Œä½†æ¨èä½¿ç”¨é¢„é‡‡æ ·æ–¹å¼ä»¥ç¡®ä¿ä¸€è‡´æ€§ã€‚

**Q: é‡‡æ ·ä¼šå½±å“éªŒè¯é›†å—ï¼Ÿ**  
A: ä¸ä¼šã€‚é‡‡æ ·åªå¤„ç† `train.json`ï¼ŒéªŒè¯é›†ä»é‡‡æ ·åçš„è®­ç»ƒé›†ä¸­æŒ‰ `--val_ratio` åˆ’åˆ†ã€‚

**Q: å¦‚ä½•ç¡®è®¤é‡‡æ ·ç»“æœï¼Ÿ**  
A: é‡‡æ ·è„šæœ¬ä¼šè¾“å‡ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŸå§‹æ ·æœ¬æ•°ã€æ–°æ ·æœ¬æ•°ã€ç§»é™¤æ ·æœ¬æ•°ã€å—å½±å“ç”¨æˆ·æ•°ç­‰ã€‚

## ğŸ“ ç¤ºä¾‹è¾“å‡º

```
================================================================================
æ•°æ®é›†é‡‡æ ·å·¥å…·
================================================================================
è¾“å…¥æ–‡ä»¶: /mnt/parallel/GIDigitalTwinBench/RealSelf/Chameleons/train.json
è¾“å‡ºæ–‡ä»¶: sampled_data/Chameleons/train_3.json
æ¯ç”¨æˆ·æœ€å¤šæ ·æœ¬æ•°: 3
éšæœºç§å­: 42

ğŸ“– è¯»å–æ•°æ®é›†...
âœ… åŸå§‹æ ·æœ¬æ•°: 7797
ğŸ“Š æŒ‰ç”¨æˆ·åˆ†ç»„ (ä½¿ç”¨å­—æ®µ: user_hash)...
âœ… å”¯ä¸€ç”¨æˆ·æ•°: 6117
âœ… å¹³å‡æ¯ç”¨æˆ·æ ·æœ¬æ•°: 1.27

æ ·æœ¬æ•°åˆ†å¸ƒ (å‰10ä¸ª):
    1 ä¸ªæ ·æœ¬:  5342 ä¸ªç”¨æˆ·
    2 ä¸ªæ ·æœ¬:   460 ä¸ªç”¨æˆ·
    3 ä¸ªæ ·æœ¬:   151 ä¸ªç”¨æˆ·
    4 ä¸ªæ ·æœ¬:    54 ä¸ªç”¨æˆ·
    5 ä¸ªæ ·æœ¬:    45 ä¸ªç”¨æˆ·
    ...

ğŸ² å¼€å§‹é‡‡æ · (æ¯ç”¨æˆ·æœ€å¤š 3 ä¸ªæ ·æœ¬)...
âœ… é‡‡æ ·å®Œæˆ
   - æ–°æ ·æœ¬æ•°: 7207
   - ç§»é™¤æ ·æœ¬æ•°: 590 (7.57%)
   - å—å½±å“ç”¨æˆ·æ•°: 164 (2.68%)
   - ä¿ç•™æ¯”ä¾‹: 92.43%

ğŸ’¾ ä¿å­˜åˆ°: sampled_data/Chameleons/train_3.json
âœ… å®Œæˆï¼
================================================================================
```

## ğŸ¯ æ€»ç»“

ä½¿ç”¨æ•°æ®é›†é‡‡æ ·å·¥å…·å¯ä»¥ï¼š
- âœ… å¿«é€Ÿç”Ÿæˆå›ºå®šçš„è®­ç»ƒæ•°æ®å­é›†
- âœ… æ§åˆ¶æ¯ä¸ªç”¨æˆ·çš„æ ·æœ¬æ•°é‡
- âœ… æé«˜è®­ç»ƒæ•ˆç‡å’Œå¯é‡å¤æ€§
- âœ… å‡å°‘è¿‡æ‹Ÿåˆé£é™©

æ¨èåœ¨å¤§è§„æ¨¡å®éªŒå‰ï¼Œå…ˆä½¿ç”¨é‡‡æ ·æ•°æ®é›†è¿›è¡Œå¿«é€ŸéªŒè¯ï¼

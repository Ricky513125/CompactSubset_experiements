# 当前清洗逻辑流程总结

## 当前逻辑（混乱）
1. 检测乱码
2. 移除元数据标签
3. 移除格式标记
4. 移除指令性文本
5. **提取特殊格式**（[AI_RESPONSE], [RESPONSE], 答え: 等）
6. 移除标签和指令性文本（重复）
7. 截断到角色标识
8. 移除括号注释
9. 处理示例列表
10. 去重（多个步骤，重复）
11. 提取第一句话
12. 规范化Unicode
13. 移除标点符号
14. 清理空白
15. 检测英文输出
16. 截断过长文本
17. 最终清理（包括移除开头的上括号）

## 问题
- 逻辑混乱：先移除很多东西，然后又提取，然后又移除
- 重复处理：去重逻辑在多个地方重复
- 顺序不合理：应该先提取有效信息，再清洗

## 建议的新逻辑（清晰）
1. **第一步：提取有效信息**
   - 从特殊格式中提取：[AI_RESPONSE], [RESPONSE], 答え:, [OUTPUT], [RESULT], 示例列表等
   - 优先提取，确保获得实际内容

2. **第二步：移除元数据和格式标记**
   - 移除元数据标签（<|im_start|>, <think>等）
   - 移除格式标记（User:, Assistant:, LaTeX, 箭头等）
   - 移除所有标签（[xxx], 【xxx】）

3. **第三步：移除指令性文本**
   - 移除所有指令性文本（日文、中文、英文）
   - 截断到角色标识之前

4. **第四步：去重**
   - 处理示例列表中的重复
   - 处理引号内的重复
   - 处理句子级别的重复
   - 处理短语级别的重复

5. **第五步：提取有效句子**
   - 只保留第一个有效句子
   - 跳过指令性文本

6. **第六步：格式规范化**
   - 规范化Unicode字符
   - 移除多余的标点符号
   - 清理空白
   - 检测英文输出（应该返回空）

7. **第七步：最终处理**
   - 截断过长文本
   - 移除开头的上括号（如果只有开头没有闭合）
   - 最终清理空白
   - 确保结果不为空
